worker_processes auto;

events { worker_connections 1024; }

http {
  upstream auth_service    { server auth-service:8000; }
  upstream product_service { server product-service:3000; }
  upstream order_service   { server order-service:3001; }
  upstream payment_service { server payment-service:8080; }

  server {
    listen 80;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Auth endpoints are public
    location /api/auth/ {
      proxy_pass http://auth_service;
    }

    # Internal auth check used by auth_request
    location = /_auth_check {
      internal;

      proxy_pass http://auth_service/api/auth/verify;
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";

      # Forward token sources to auth-service
      proxy_set_header Authorization $http_authorization;
      proxy_set_header Cookie        $http_cookie;
    }

    # Protected: products
    location /api/products/ {
      auth_request /_auth_check;

      auth_request_set $user_id $upstream_http_x_user_id;
      auth_request_set $role    $upstream_http_x_user_role;
      auth_request_set $mfa     $upstream_http_x_user_mfa;

      proxy_set_header X-User-Id   $user_id;
      proxy_set_header X-User-Role $role;
      proxy_set_header X-User-Mfa  $mfa;

      proxy_pass http://product_service;
    }

    # Protected: orders
    location /api/orders/ {
      auth_request /_auth_check;

      auth_request_set $user_id $upstream_http_x_user_id;
      auth_request_set $role    $upstream_http_x_user_role;
      auth_request_set $mfa     $upstream_http_x_user_mfa;

      proxy_set_header X-User-Id   $user_id;
      proxy_set_header X-User-Role $role;
      proxy_set_header X-User-Mfa  $mfa;

      proxy_pass http://order_service;
    }

    # Protected: payments
    location /api/payments/ {
      auth_request /_auth_check;

      auth_request_set $user_id $upstream_http_x_user_id;
      auth_request_set $role    $upstream_http_x_user_role;
      auth_request_set $mfa     $upstream_http_x_user_mfa;

      proxy_set_header X-User-Id   $user_id;
      proxy_set_header X-User-Role $role;
      proxy_set_header X-User-Mfa  $mfa;

      proxy_pass http://payment_service;
    }
  }
}
